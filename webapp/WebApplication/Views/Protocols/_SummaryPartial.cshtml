@using K9.Base.WebApplication.Extensions
@using K9.Base.WebApplication.Helpers
@using K9.DataAccessLayer.Enums
@using K9.SharedLibrary.Authentication
@using K9.WebApplication.Helpers
@using K9.WebApplication.ViewModels
@model Protocol

@{
    var wellClass = "";

    if (ViewBag.ProtocolView != null)
    {
        wellClass = "well";
    }
}

@using (Html.BeginForm())
{
    using (Html.BeginBootstrapForm())
    {
        @Html.HiddenFor(e => Model.Id)

        <div class="row margin-bottom-15">
            <div class="col-xs-12">
                @Html.BootstrapActionLinkButton(Dictionary.ViewPrintableVersion, "PrintableSummary", "Protocol", new { id = Model.ExternalId }, "fa fa-eye", EButtonClass.Success)

                @if (Model.Type != EProtocolType.AutoGenerated)
                {
                    if (Model.ProductPacks != null && Model.ProductPacks.Any())
                    {
                        foreach (var protocolProductPack in Model.ProductPacks)
                        {
                            @Html.BootstrapActionLinkButton($"{Dictionary.View} {protocolProductPack.ProductPack.Name}", "Details", "ProductPack", new { seoFriendlyId = protocolProductPack.ProductPack.SeoFriendlyId }, "", EButtonClass.Success)
                        }
                    }
                }

                @if (K9.WebApplication.Helpers.SessionHelper.CurrentUserIsAdmin())
                {
                    @Html.BootstrapBackToListButton()
                }
            </div>
        </div>

        if (K9.WebApplication.Helpers.SessionHelper.CurrentUserIsAdmin())
        {
            <div class="row">
                <div class="col-xs-12">
                    @Html.BootstrapEditorFor(model => Model.ProtocolId)
                </div>
            </div>
        }

        if (Model.ProtocolSections.Any())
        {
            @Html.Partial("../Protocols/_Schedule")
        }


        if (Model.Type == EProtocolType.Default)
        {
            @Html.Partial("../Protocols/_SupplementsList")
        }
    }
}

<div class="@wellClass">
    <ul class="nav nav-pills">
        @if (Model.RecommendedFoods != null && Model.RecommendedFoods.Any())
        {
            <li class="active">
                <a data-toggle="pill" href="#recommended-foods">
                    <span class="site-controls-text">
                        @Dictionary.RecommendedFoods
                    </span>
                </a>
            </li>
        }
        @if (Model.DietaryRecommendations != null && Model.DietaryRecommendations.Any())
        {
            <li>
                <a data-toggle="pill" href="#dietary-recommendations">
                    <span class="site-controls-text">
                        @Dictionary.DietaryAdvice
                    </span>
                </a>
            </li>
        }
        @if (Model.Activities != null && Model.Activities.Any())
        {
            <li>
                <a data-toggle="pill" href="#activities">
                    <span class="site-controls-text">
                        @Dictionary.RecommendedActivitties
                    </span>
                </a>
            </li>
        }
        @if (Model.Type == EProtocolType.AutoGenerated && Model.Products != null && Model.Products.Any())
        {
            <li>
                <a data-toggle="pill" href="#recommended-products">
                    <span class="site-controls-text">
                        @Dictionary.RecommendedProducts
                    </span>
                </a>
            </li>
        }
        @if (Model.Type == EProtocolType.AutoGenerated && Model.ProductPacks != null && Model.ProductPacks.Any())
        {
            <li>
                <a data-toggle="pill" href="#recommended-productpacks">
                    <span class="site-controls-text">
                        @Dictionary.RecommendedProductPacks
                    </span>
                </a>
            </li>
        }
    </ul>

    <div class="tab-content">
        <div id="recommended-foods" class="tab-pane fade active in padding-top-15">
            @if (Model.RecommendedFoods != null && Model.RecommendedFoods.Any())
            {
                <div class="well">
                    <div class="row margin-top-0">
                        <div class="col-xs-12">
                            <h3 class="margin-top-0">@Dictionary.RecommendedFoods</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            @Html.Partial("../Protocols/_RecommendedFoods", new RecommendedFoodsViewModel
                            {
                                GenoType =  Model.GenoType,
                                RecommendedFoods = Model.RecommendedFoods.Select(e =>
                                {
                                    var foodItem = e.FoodItem;
                                    foodItem.Score = e.Score;
                                    foodItem.RelativeScore = e.RelativeScore;
                                    return foodItem;
                                }).ToList()
                            })
                        </div>
                    </div>
                </div>
            }
        </div>

        <div id="dietary-recommendations" class="tab-pane fade padding-top-15">
            @if (Model.DietaryRecommendations != null && Model.DietaryRecommendations.Any())
            {
                <div class="well">
                    <div class="row margin-top-0">
                        <div class="col-xs-12">
                            <h3 class="margin-top-0">@Dictionary.DietaryAdvice</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            @Html.Partial("../Protocols/_DietaryRecommendationsSummary")
                        </div>
                    </div>
                </div>

                <div class="well">
                    <div class="row margin-top-0">
                        <div class="col-xs-12">
                            <h3 class="margin-top-0">@Dictionary.DietaryAdvice - @Dictionary.Details</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            @Html.Partial("../Protocols/_DietaryRecommendationsFields")
                        </div>
                    </div>
                </div>
            }
        </div>

        <div id="activities" class="tab-pane fade padding-top-15">
            @if (Model.Activities != null && Model.Activities.Any())
            {
                <div class="well">
                    <div class="row margin-top-0">
                        <div class="col-xs-12">
                            <h3 class="margin-top-0">@Dictionary.RecommendedActivitties</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            @Html.Partial("../Protocols/_ActivitiesSummary")
                        </div>
                    </div>
                </div>

                <div class="well">
                    <div class="row margin-top-0">
                        <div class="col-xs-12">
                            <h3 class="margin-top-0">@Dictionary.RecommendedActivitties - @Dictionary.Details</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            @Html.Partial("../Protocols/_ActivityFields")
                        </div>
                    </div>
                </div>
            }
        </div>

        <div id="recommended-products" class="tab-pane fade padding-top-15">
            @if (Model.Products != null && Model.Products.Any())
            {
                <div class="well">
                    <div class="row margin-top-0">
                        <div class="col-xs-12">
                            <h3 class="margin-top-0">@Dictionary.RecommendedProducts</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            @Html.Partial("../Protocols/_RecommendedProducts")
                        </div>
                    </div>
                </div>
            }
        </div>

        <div id="recommended-productpacks" class="tab-pane fade padding-top-15">
            @if (Model.Products != null && Model.Products.Any())
            {
                <div class="well">
                    <div class="row margin-top-0">
                        <div class="col-xs-12">
                            <h3 class="margin-top-0">@Dictionary.RecommendedProductPacks</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-xs-12">
                            @Html.Partial("../Protocols/_RecommendedProductPacks")
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        $("#ProtocolId").change(function () {
            $("#ProtocolId").closest("form").submit();
        });
    })
</script>
